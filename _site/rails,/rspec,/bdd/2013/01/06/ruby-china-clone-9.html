<p><a href="/blog/2013/01/06/ruby-china-clone-cover">目录</a>
上一步：<a href="/blog/2013/01/06/ruby-china-clone-8">使用 RSpec+Capybara 简单BDD入门 -8</a></p>

<h2>用户故事</h2>

<p>用户希望看到帖子的回复列表</p>

<ul>
<li>显示帖子的回复数量</li>
<li>显示回复的下列信息

<ul>
<li>回复日期时间</li>
<li>回复内容</li>
</ul>
</li>
</ul>


<h2>环境准备</h2>

<pre><code class="bash">git checkout -b f9
rails c # console
rails s # server
</code></pre>

<h2>步骤</h2>

<h3>编辑<code>spec/features/guest_can_see_topic_info_spec.rb</code>，增加回复部分的验证</h3>

<pre><code class="rb">  scenario '应该显示帖子的回复信息' do
    visit "/topics/#{@topic.id}"

    page.should have_content "共收到 5 条回复"
  end
</code></pre>

<ul>
<li>测试失败：<code>expected there to be text "共收到 5 条回复" in "社区 会员...</code></li>
<li>原因：还没有实现代码</li>
</ul>


<h3>编辑<code>topics/show.html.haml</code></h3>

<p>拷贝<code>ui/topic.html.haml</code>的回复部分到当前模板</p>

<pre><code class="rb">  %section#topic_content.box
    %p= @topic.content

  %section#replies_banner.box.info-box
    %span 共收到 5 条回复

  %section#replies.box
    %ul
      %li
        %a.span1(href="")
          %img(src="#{gravatar_url('joe@example.com')}")
        %article.span8
          = link_to "knwang", nil, class: "user_link"
          %span two hours ago
          %p ++ -- 这个操作就是罪恶的源泉。。++ -- 这个操作就是罪恶的源泉。。++ -- 这个操作就是罪恶的源泉。。++ -- 这个操作就是罪恶的源泉。。++ -- 这个操作就是罪恶的源泉。。++ -- 这个操作就是罪恶的源泉。。
      %li
        %a.span1(href="")
          %img(src="#{gravatar_url('joe@example.com')}")
        %article.span8
          = link_to "knwang", nil, class: "user_link"
          %span two hours ago
          %p ++ -- 这个操作就是罪恶的源泉。。
      %li
        %a.span1(href="")
          %img(src="#{gravatar_url('joe@example.com')}")
        %article.span8
          = link_to "knwang", nil, class: "user_link"
          %span two hours ago
          %p ++ -- 这个操作就是罪恶的源泉。。


%section#sidebar
  %section#new_topic.box
</code></pre>

<p>并修改为</p>

<pre><code class="rb">  %section#topic_content.box
    %p= @topic.content

  %section#replies_banner.box.info-box
    %span= "共收到 #{@topic.replies.count} 条回复"

  %section#replies.box
    %ul
      - @topic.replies.each do |reply|
        %li
          %a.span1(href="")
            %img(src="#{gravatar_url('joe@example.com')}")
          %article.span8
            = link_to "knwang", nil, class: "user_link"
            %span= "#{time_ago_in_words(reply.created_at)} ago"
            %p= reply.content 

%section#sidebar
  %section#new_topic.box
</code></pre>

<p><strong>注意：回复的<code>user</code>暂时先不考虑</strong></p>

<ul>
<li>测试失败：`undefined methodreplies' for #Topic:0x007fc0f5c4b3b0...``</li>
<li>原因：没有<code>replies</code>定义</li>
</ul>


<h3>编辑<code>models/topic.rb</code>，增加关联定义</h3>

<pre><code class="rb">  has_many :replies
</code></pre>

<ul>
<li>测试失败：<code>uninitialized constant Topic::Reply</code></li>
<li>原因：没有<code>Reply</code>这个<code>model</code>的定义</li>
</ul>


<h3>在<code>rails console</code>中执行</h3>

<pre><code class="rb">[26] pry(main)&gt; generate "model reply content:text topic_id:integer"
      invoke  active_record
      create    db/migrate/20130103064335_create_replies.rb
      create    app/models/reply.rb
=&gt; "Completed"
[27] pry(main)&gt;
</code></pre>

<h3>执行数据库升级</h3>

<pre><code class="bash">bundle exec rake db:migrate
bundle exec rake db:test:prepare
</code></pre>

<h3>修改spec文件</h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到帖子的详细信息' do
  background do
    @node = Node.create name: "Ruby"
    @topic = Topic.create title: "topic 1 test", content: "topic 1 content",  node: @node

    5.times.map.with_index { |i| Reply.create content: "reply #{i}", topic: @topic, user: user }
  end

  scenario '应该显示帖子的详细信息' do
......
  end

  scenario '应该显示帖子的回复信息' do
    visit "/topics/#{@topic.id}"

    page.should have_content "共收到 #{@topic.replies.count} 条回复"

    @topic.replies.each do |reply|
      page.should have_content reply.content
    end
  end
end
</code></pre>

<ul>
<li>测试失败：<code>Can't mass-assign protected attributes: topic, user</code></li>
<li>原因：没有设置<code>topic,user</code>的访问属性</li>
</ul>


<h3>编辑<code>models/reply.rb</code>，增加访问属性并设置topic和user的关联</h3>

<pre><code class="rb">class Reply &lt; ActiveRecord::Base
  attr_accessible :content, :topic

  belongs_to :topic
end
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h2>完成，提交代码</h2>

<pre><code class="bash">git add .
git commit 
git checkout dev
git merge f9 --no-ff
git branch -d f9
</code></pre>

<p>下一步骤：<a href="/blog/2013/01/06/ruby-china-clone-10">使用 RSpec+Capybara 简单BDD入门 -10</a></p>
