<p><a href="/blog/2013/01/06/ruby-china-clone-cover">目录</a>
上一步：<a href="/blog/2013/01/06/ruby-china-clone-1">使用 RSpec+Capybara 简单BDD入门 -1</a></p>

<h2>用户故事</h2>

<p>访问者希望登录</p>

<ul>
<li>使用用户名登录</li>
<li>登录后显示帖子列表</li>
<li>在右上角显示用户名</li>
</ul>


<h2>环境准备</h2>

<pre><code class="bash">git checkout -b f7
rails c # console
rails s # server
</code></pre>

<h2>步骤</h2>

<h3>新建文件<code>spec/features/guest_can_sign_in_spec.rb</code></h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望登录' do
  background do
    @user = User.create name: "test_user", email: "test@test.com"
  end

  scenario '输入用户名后点击"登录"按钮，应该正常登录' do
    visit "/sign_in"

    fill_in "user_name", with: @user.name
    click_button "登录"

    current_path.should == root_path
  end
end
</code></pre>

<ul>
<li>测试失败：<code>No route matches [GET] "/sign_in"</code></li>
<li>原因：没有<code>sign_in</code>的路由信息</li>
</ul>


<h3>编辑<code>config/routes.rb</code>，增加路由信息</h3>

<pre><code class="rb">  match 'sign_in', to: "sessions#new"
</code></pre>

<ul>
<li>测试失败：<code>uninitialized constant SessionsController</code></li>
<li>原因：没有<code>sessions</code>这个<code>controller</code></li>
</ul>


<h3>在<code>rails console</code>中执行</h3>

<pre><code class="rb">[10] pry(main)&gt; generate "controller sessions"
      create  app/controllers/sessions_controller.rb
      invoke  haml
      create    app/views/sessions
=&gt; "Completed"
[11] pry(main)&gt;
</code></pre>

<ul>
<li>测试失败：<code>The action 'new' could not be found for SessionsController</code></li>
<li>原因：没有定义<code>new</code>方法</li>
</ul>


<h3>编辑<code>controllers/sessions_controller.rb</code>，增加<code>new</code>方法</h3>

<pre><code class="rb">class SessionsController &lt; ApplicationController
  def new
  end
end
</code></pre>

<ul>
<li>测试失败：<code>Missing template sessions/new, application/new with {:lo...</code></li>
<li>原因：没有对应的<code>new</code>模板</li>
</ul>


<h3>新建<code>sessions/new.html.haml</code>模板</h3>

<p>拷贝<code>ui/signin.html</code>内容至当前模板</p>

<pre><code class="rb">= render 'shared/breadcrumb', links: [["Home", ""]]

%section#sign_in.box
  %h1 登录
  %form(action="" method="post" class="form-horizontal")
    .control-group
      %label(class="control-label") 用户名
      .controls
        %input(type="text")
    .submit-button
      %input(type="submit" value="登录" class="btn btn-primary")

%section#sidebar
  %section#has_account.box
    %h2 还没有帐号?
    = link_to "注册"
</code></pre>

<ul>
<li>测试失败：<code>Unable to find field "user_name"</code></li>
<li>原因：模板还是写死的假数据</li>
</ul>


<h3>修改<code>sessions/new.html.haml</code>模板</h3>

<pre><code class="rb">= render 'shared/breadcrumb', links: [["Home", ""]]

%section#sign_in.box
  %h1 登录
  = form_tag sessions_path, method: :post, class: "form-horizontal" do
    .control-group
      = label_tag :user_name, "用户名", class: "control-label"
      .controls
        = text_field_tag :user_name
    .submit-button
      = submit_tag "登录", class: "btn btn-primary"

%section#sidebar
  %section#has_account.box
    %h2 还没有帐号?
    = link_to "注册"
</code></pre>

<ul>
<li>测试失败：`undefined local variable or methodsessions_path' for #&lt;...``</li>
<li>原因：没有<code>sessions#create</code>的路由信息</li>
</ul>


<h3>编辑<code>config/routes.rb</code>，增加路由信息</h3>

<pre><code class="rb">  resources :sessions, only: [:create]
</code></pre>

<ul>
<li>测试失败：<code>The action 'create' could not be found for SessionsController</code></li>
<li>原因：没有定义<code>create</code>方法</li>
</ul>


<h3>编辑<code>controllers/sessions_controller</code>，增加<code>create</code>方法</h3>

<pre><code class="rb">  def create
  end
</code></pre>

<ul>
<li>测试失败：<code>Missing template sessions/create, application/create with {:l...</code></li>
<li>原因：没有<code>sessions/create</code>模板</li>
</ul>


<h3>编辑<code>controllers/sessions_controller</code>，修改<code>create</code>方法内容</h3>

<pre><code class="rb">  def create
    session[:user_name] = params[:user_name]
    redirect_to root_path
  end
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h2>确认用户故事，增加spec</h2>

<h3>编辑<code>spec/features/guest_can_sign_in_spec.rb</code></h3>

<pre><code class="rb">  scenario '应该显示用户名称' do
    visit "/sign_in"

    fill_in "user_name", with: @user.name
    click_button "登录"

    page.should have_content @user.name    
  end
</code></pre>

<ul>
<li>测试失败：<code>expected there to be text "test_user" in "社区 会员 knowa...</code></li>
<li>原因：还没有写显示用户名称的代码</li>
</ul>


<h3>编辑<code>layouts/application.html.haml</code></h3>

<p>把第22行knowang的部分修改为实际代码</p>

<pre><code class="rb">            = current_user.name
</code></pre>

<ul>
<li>测试失败：`undefined local variable or methodcurrent_user' for #&lt;...``</li>
<li>原因：没有定义<code>current_user</code>方法</li>
</ul>


<h3>编辑<code>controllers/application_controller.rb</code>，增加<code>current_user</code>的定义</h3>

<pre><code class="rb">class ApplicationController &lt; ActionController::Base
  protect_from_forgery

  helper_method :current_user

  private
  def current_user
    user = User.new
    user = User.find_by_name(session[:user_name]) if session[:user_name]
    user
  end
end
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h2>完成，提交代码</h2>

<pre><code class="bash">git add .
git commit 
git checkout dev
git merge f7 --no-ff
git branch -d f7
</code></pre>

<p>下一步骤：<a href="http://ruby-china.org/topics/7781">使用 RSpec+Capybara 简单BDD入门 -8</a></p>

<h2>用户故事</h2>

<p>访问者希望看到帖子的节点</p>

<ul>
<li>在帖子列表中显示帖子名称</li>
</ul>


<h2>环境准备</h2>

<pre><code class="bash">git checkout -b f2
rails c # console
rails s # server
</code></pre>

<h2>步骤</h2>

<h3>新建文件<code>spec/features/guest_can_see_node_name_spec.rb</code></h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到帖子的节点名称' do
  background do
    Topic.delete_all

    Topic.create title: "DHH 的公开课"
    Topic.create title: "Rails3 中 compass 的 IE 使用问题"
    Topic.create title: "这周二上海搞Ruby Tuesday么？"
  end

  scenario do
    visit '/topics'

    page.should have_content '瞎扯淡'
  end
end
</code></pre>

<ul>
<li>测试失败：<code>expected there to be text "瞎扯淡" in "社区 会员 knowan...</code></li>
<li>原因：还没有实现的代码</li>
</ul>


<h3>编辑topics/index.html.haml</h3>

<p>把这一行</p>

<pre><code class="rb">= link_to "分享", nil, class: "node"
</code></pre>

<p>修改为</p>

<pre><code class="rb">= link_to topic.node.name, nil, class: "node"
</code></pre>

<ul>
<li>测试失败：`undefined methodnode' for #Topic:0x007fa4bc0d96d0``</li>
<li>原因：没有<code>node</code>这个方法</li>
</ul>


<h3>编辑<code>model/topic.rb</code></h3>

<p>增加</p>

<pre><code class="rb">  belongs_to :node
</code></pre>

<ul>
<li>测试失败：`undefined methodname' for nil:NilClass``</li>
<li>原因：<code>node</code>没有值</li>
</ul>


<h3>生成<code>Node</code>这个<code>model</code>，在<code>rails console</code>中执行</h3>

<pre><code class="rb">[5] pry(main)&gt; generate "model node name:string"
      invoke  active_record
      create    db/migrate/20121231023808_create_nodes.rb
      create    app/models/node.rb
=&gt; "Completed"
[6] pry(main)&gt;
</code></pre>

<h3>增加<code>node_id</code>。在<code>rails console</code>中执行</h3>

<pre><code class="rb">[13] pry(main)&gt; generate "migration AddNodeIdToTopics node_id:integer"
      invoke  active_record
      create    db/migrate/20121231030435_add_node_id_to_topics.rb
=&gt; "Completed"
[14] pry(main)&gt;
</code></pre>

<h3>执行数据库升级</h3>

<pre><code class="bash">bundle exec rake db:migrate
bundle exec rake db:test:prepare
</code></pre>

<h3>修改测试用例</h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到帖子的节点名称' do
  background do
    Topic.delete_all
    Node.delete_all

    node = Node.create name: "瞎扯淡"

    Topic.create title: "DHH 的公开课", node: node
    Topic.create title: "Rails3 中 compass 的 IE 使用问题", node: node
    Topic.create title: "这周二上海搞Ruby Tuesday么？", node: node
  end

  scenario '访问/topics, 应该显示所有帖子的节点名称' do
    visit '/topics'

    Topic.all.each do |topic|
      page.should have_content topic.node.name
    end
  end
end
</code></pre>

<ul>
<li>测试失败：<code>Can't mass-assign protected attributes: node</code></li>
<li>原因：没有对<code>node</code>设置访问属性</li>
</ul>


<h3>修改<code>model/node.rb</code>，增加<code>node</code>的属性声明</h3>

<pre><code class="rb">  attr_accessible :name, :node
</code></pre>

<ul>
<li>当前测试成功，但前一个测试失败</li>
<li>原因：前一个测试用例中没有设置<code>node</code>信息</li>
</ul>


<h3>修改测试用例<code>spec/features/guest_can_see_all_topics_spec.rb</code>，增加<code>Node</code>的赋值</h3>

<pre><code class="rb">    Node.delete_all

    node = Node.create name: "瞎扯淡"

    Topic.create title: "DHH 的公开课", node: node
    Topic.create title: "Rails3 中 compass 的 IE 使用问题", node: node
    Topic.create title: "这周二上海搞Ruby Tuesday么？", node: node
</code></pre>

<ul>
<li>测试全部通过</li>
</ul>


<h2>提交代码</h2>

<pre><code class="bash">git add .
git commit 
git checkout dev
git merge f2 --no-ff
git branch -d f2
</code></pre>

<p>下一步骤：<a href="/blog/2013/01/06/ruby-china-clone-3">使用 RSpec+Capybara 简单BDD入门 -3</a></p>
