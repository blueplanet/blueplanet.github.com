<p><a href="/blog/2013/01/06/ruby-china-clone-cover">目录</a>
上一步：<a href="/blog/2013/01/06/ruby-china-clone-9">使用 RSpec+Capybara 简单BDD入门 -9</a></p>

<h2>用户故事</h2>

<p>用户希望看到最新回复的信息</p>

<p>帖子列表页面上显示最新回复的信息</p>

<ul>
<li>回复人</li>
<li>回复日期</li>
</ul>


<p>补充：
- 实际的目的是把回复和用户关联起来</p>

<h2>环境准备</h2>

<pre><code class="bash">git checkout -b f10
rails c # console
rails s # server
</code></pre>

<h2>步骤</h2>

<h3>编辑<code>spec/features/topics_spec.rb</code>，增加最新回复的验证部分</h3>

<pre><code class="rb">    scenario '应该显示帖子的最新回复的信息' do
      page.should have_content "last replied by #{@user.name} less than a minute ago"
    end
</code></pre>

<ul>
<li>测试失败：<code>expected there to be text "last replied by test_user less than a minute ago" i...</code></li>
<li>原因：还没有实现具体的代码</li>
</ul>


<h3>编辑<code>topics/_topics.html.haml</code></h3>

<p>拷贝<code>ui/topics.html</code>中最新回复的部分至当前模板</p>

<pre><code class="rb">          %span= "  •  "
          last replied by
          = link_to "knwang", nil, class: "user_link"
          4 mintes ago
</code></pre>

<p>修改为</p>

<pre><code class="rb">          - last_replay = topic.replies.last
          - if last_replay
            %span= "  •  "
            last replied by
            = link_to last_replay.user.name, last_replay.user, class: "user_link"
            = "#{time_ago_in_words(last_replay.created_at)} ago"
</code></pre>

<p>在测试用例的<code>background</code>部分加入<code>replay</code>的数据</p>

<pre><code class="rb">    Topic.last.replies.create content: 'test replay', user: @user
</code></pre>

<ul>
<li>测试失败：<code>Can't mass-assign protected attributes: user</code></li>
<li>原因：没有设置<code>user</code>的访问属性</li>
</ul>


<h3>编辑<code>models/reply.rb</code>，增加用户关联并设置访问属性</h3>

<pre><code class="rb">class Reply &lt; ActiveRecord::Base
  attr_accessible :content, :topic, :user

  belongs_to :topic
  belongs_to :user
end
</code></pre>

<h3>在<code>rails console</code>中执行</h3>

<pre><code class="rb">[32] pry(main)&gt; generate "migration AddUserIdToReplies user_id:integer"
      invoke  active_record
      create    db/migrate/20130103120615_add_user_id_to_replies.rb
=&gt; "Completed"
[33] pry(main)&gt;
</code></pre>

<h3>执行数据库升级</h3>

<pre><code class="bash">bundle exec rake db:migrate
bundle exec rake db:test:prepare
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h2>完成，提交代码</h2>

<pre><code class="bash">git add .
git commit 
git checkout dev
git merge f10 --no-ff
git branch -d f10
</code></pre>

<p>下一步骤：<a href="/blog/2013/01/06/ruby-china-clone-11">使用 RSpec+Capybara 简单BDD入门 -11</a></p>
