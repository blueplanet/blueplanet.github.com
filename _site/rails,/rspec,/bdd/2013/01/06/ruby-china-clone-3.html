<p><a href="/blog/2013/01/06/ruby-china-clone-cover/">目录</a>
上一步：<a href="/blog/2013/01/06/ruby-china-clone-2/">使用 RSpec+Capybara 简单BDD入门 -2</a></p>

<h2>用户故事</h2>

<p>访问者希望看到一个节点的帖子列表</p>

<ul>
<li>点击节点后显示该节点的帖子列表</li>
</ul>


<h2>环境准备</h2>

<pre><code class="bash">git checkout -b f3
rails c # console
rails s # server
</code></pre>

<h2>步骤</h2>

<h3>新建文件<code>spec/features/nodes_spec.rb</code></h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到一个节点的帖子列表' do
  background do
    @node1 = Node.create name: "Ruby Node"
    @node2 = Node.create name: "Rails Node"

    2.times.map.with_index { |i| Topic.create title: "topic #{i}", node: @node1}
    3.times.map.with_index { |i| Topic.create title: "topic #{i + 10}", node: @node2}
  end

  scenario '点击节点名称后，应该显示该节点的帖子列表' do
    visit '/topics'

    page.should have_content @node1.name
    page.should have_content @node2.name

    first(:link, @node1.name).click

    page.should have_content @node1.name
    page.should_not have_content @node2.name
  end
end
</code></pre>

<ul>
<li>测试失败：<code>Failure/Error: page.should_not have_content @node2.name expected there not to be text "Rails Node" in "....</code></li>
<li>原因：节点的链接还是无效链接，没有起作用</li>
</ul>


<h3>修改<code>topics/index.html.haml</code></h3>

<pre><code class="rb">= link_to topic.node.name, nil, class: "node"
</code></pre>

<p>修改为</p>

<pre><code class="rb">= link_to topic.node.name, , class: "node"
</code></pre>

<ul>
<li>测试失败：<code>undefined method node_path' for ...</code></li>
<li>原因：没有定义<code>node</code>的路由信息</li>
</ul>


<h3>修改<code>config/routes.rb</code>，增加<code>node</code>的路由定义</h3>

<pre><code class="rb">  resources :nodes, only: [:show]
</code></pre>

<ul>
<li>测试失败：<code>uninitialized constant NodesController</code></li>
<li>原因：没有node controller</li>
</ul>


<h3>在<code>rails console</code>中执行</h3>

<pre><code class="rb">[3] pry(main)&gt; generate "controller nodes"
      create  app/controllers/nodes_controller.rb
      invoke  haml
      create    app/views/nodes
=&gt; "Completed"
[4] pry(main)&gt;
</code></pre>

<ul>
<li>测试失败：<code>The action 'show' could not be found for NodesController</code></li>
<li>原因：没有<code>show</code>方法</li>
</ul>


<h3>编辑<code>controllers/nodes_controller.rb</code>，增加<code>show</code>方法</h3>

<pre><code class="rb">class NodesController &lt; ApplicationController
  def show
  end
end
</code></pre>

<ul>
<li>测试失败：<code>Missing template nodes/show, application/show with {:...</code></li>
<li>原因：没有<code>show</code>模板</li>
</ul>


<h3>新建<code>views/nodes/show.html.haml</code></h3>

<p>拷贝<code>ui/node.html</code>至上述文件，并修改第5行</p>

<pre><code class="rb">    %h2= node.name
</code></pre>

<ul>
<li>测试失败：<code>undefined methodname' for nil:NilClass</code></li>
<li>原因：没有对<code>@node</code>赋值</li>
</ul>


<h3>编辑<code>controllers/nodes_controller.rb</code>，增加<code>@node</code>的赋值</h3>

<pre><code class="rb">    @node = Node.find(params[:id])
</code></pre>

<ul>
<li>测试成功！但只是因为都是写死的数据，所以需要继续修改</li>
</ul>


<h3>修改<code>nodes/show.html.haml</code>第7行</h3>

<pre><code class="rb">%p= @node.description
</code></pre>

<ul>
<li>测试失败：`undefined methoddescription' for #&lt;...``</li>
<li>原因：<code>node</code>没有<code>description</code>方法</li>
</ul>


<h3>在<code>rails console</code>中执行</h3>

<pre><code class="rb">[4] pry(main)&gt; generate "migration AddDescriptionToNodes description:text"
      invoke  active_record
      create    db/migrate/20130101042100_add_description_to_nodes.rb
=&gt; "Completed"
[5] pry(main)&gt;
</code></pre>

<h3>执行数据库升级</h3>

<pre><code class="bash">bundle exec rake db:migrate
bundle exec rake db:test:prepare
</code></pre>

<ul>
<li>测试成功。但各个帖子的信息还是写死的数据</li>
</ul>


<h3>编辑<code>controllers/nodes_controller.rb</code>，修改帖子列表的部分</h3>

<pre><code class="rb">= render 'shared/breadcrumb', links: [["Home", ""], ["社区", ""], ["Ruby", ""]]

%section#node_topics
  %section#node_info.box.box-gray.info-box
    %h2= @node.name
    %span 共有48个讨论主题
    %p= @node.description
  %ul.topics.box
    - @node.topics.each do |topic|
      %li
        %a.span1(href="")
          %img(src="#{gravatar_url('joe@example.com')}")
        %article.span7
          %p.topic_title
            = link_to topic.title
          %p.topic_info
            = link_to topic.node.name, topic.node, class: "node"
            %span= "  •  "
            = link_to "knwang", nil, class: "user_link"
            %span= "  •  "
            = "published #{time_ago_in_words(topic.created_at)} ago"
        %p.replies.span1
          %span 12

%section#sidebar
  %section#new_topic.box
    = link_to "发布新帖", nil, class: "btn btn-success"
  %section#stats.box
    %ul
      %li 社区会员: 4029 人
      %li 帖子数: 312 篇
      %li 回帖数: 3123 条
</code></pre>

<ul>
<li>测试失败：`undefined methodtopics' for #&lt;Node:...``</li>
<li>原因：<code>node</code>没有<code>topics</code>方法</li>
</ul>


<h3>编辑<code>model/node.rb</code>，增加<code>topics</code>的声明</h3>

<pre><code class="rb">  has_many :topics
</code></pre>

<p>测试成功！</p>

<h2>重构</h2>

<p>仔细看一下，<code>topics/index.html.haml</code>和<code>nodes/show.html.haml</code>两个页面中，显示帖子列表的部分是完全相同的，可以提出一个部分模板</p>

<h3>新建<code>topics/_topics.html.haml</code></h3>

<pre><code>%ul.topics.box
  - topics.each do |topic|
    %li
      %a.span1(href="")
        %img(src="#{gravatar_url('joe@example.com')}")
      %article.span7
        %p.topic_title
          = link_to topic.title
        %p.topic_info
          = link_to topic.node.name, topic.node, class: "node"
          %span= "  â€˘  "
          = link_to "knwang", nil, class: "user_link"
          %span= "  â€˘  "
          = "published #{time_ago_in_words(topic.created_at)} ago"
      %p.replies.span1
        %span 12
</code></pre>

<p><strong> 注意：把<code>@topics</code>变量修改为本地变量<code>topics</code></strong></p>

<h3>修改<code>topics/index.html.haml</code></h3>

<p>把文件中上述部分删除后，增加部分模板的调用</p>

<pre><code class="rb">    %span 查看： 默认
  = render 'topics', topics: @topics

%section#sidebar
  %section#new_topic.box
</code></pre>

<h3>修改nodex/show.html.haml</h3>

<p>把文件中上述部分删除后，增加部分模板的调用</p>

<pre><code class="rb">    %span 共有48个讨论主题
    %p= @node.description
  = render 'topics/topics', topics: @node.topics

%section#sidebar
  %section#new_topic.box
</code></pre>

<p><strong>注意：传入变量的部分略有不同</strong></p>

<ul>
<li>测试应该正常全部通过</li>
</ul>


<h2>完善spec</h2>

<h3>编辑<code>spec/features/nodes_spec.rb</code>，增加<code>description</code>的设置以及验证</h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到一个节点的帖子列表' do
  background do
    @node1 = Node.create name: "Ruby Node", description: "Ruby是一门优美的语言"
    @node2 = Node.create name: "Rails Node", description: "Rails是一个快速WEB开发框架"

    2.times.map.with_index { |i| Topic.create title: "topic #{i}", node: @node1}
    3.times.map.with_index { |i| Topic.create title: "topic #{i + 10}", node: @node2}
  end

  scenario '点击节点名称后，应该显示该节点的帖子列表' do
    visit '/topics'

    Node.all.each do |node|
      page.should have_content node.name
    end

    first(:link, @node1.name).click

    page.should have_content @node1.name
    page.should have_content @node1.description

    page.should_not have_content @node2.name
    page.should_not have_content @node2.description
  end
end
</code></pre>

<ul>
<li>测试失败：<code>Can't mass-assign protected attributes: description</code></li>
<li>原因：<code>description</code>的访问属性没有设置</li>
</ul>


<p>好险，这个地方忘记了！</p>

<h3>编辑<code>model/node.rb</code>，增加<code>description</code>属性声明</h3>

<pre><code class="rb">  attr_accessible :name, :description
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h2>完成，提交代码</h2>

<pre><code class="bash">git add .
git commit 
git checkout dev
git merge f3 --no-ff
git branch -d f3
</code></pre>

<p>下一步骤：<a href="/blog/2013/01/06/ruby-china-clone-4">使用 RSpec+Capybara 简单BDD入门 -4</a></p>
