<p><a href="/blog/2013/01/06/ruby-china-clone-cover">目录</a>
上一步：<a href="/blog/2013/01/06/ruby-china-clone-4">使用 RSpec+Capybara 简单BDD入门 -4</a></p>

<h2>用户故事</h2>

<p>访问者希望看到用户的信息</p>

<ul>
<li>用户名称、创建日期</li>
</ul>


<h2>环境准备</h2>

<pre><code class="bash">git checkout -b f5
rails c # console
rails s # server
</code></pre>

<h2>步骤</h2>

<h3>新建文件<code>spec/features/guest_can_see_user_info_spec.rb</code></h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到用户的信息' do
  scenario '访问/users/:id, 应该显示用户信息' do
    visit "/users/1"

    page.should have_content "test_user"
  end
end
</code></pre>

<ul>
<li>测试失败：<code>No route matches [GET] "/users/1"</code></li>
<li>原因：没有<code>/users/1</code>对应的路由信息</li>
</ul>


<h3>编辑<code>config/routes.rb</code>，增加路由信息</h3>

<pre><code class="rb">  resources :users, only: [:show]
</code></pre>

<ul>
<li>测试失败：<code>uninitialized constant UsersController</code></li>
<li>原因：没有<code>UsersController</code></li>
</ul>


<h3>在<code>rails console</code>中执行</h3>

<pre><code class="rb">[7] pry(main)&gt; generate "controller users"
      create  app/controllers/users_controller.rb
      invoke  haml
      create    app/views/users
=&gt; "Completed"
[8] pry(main)&gt;
</code></pre>

<ul>
<li>测试失败：<code>The action 'show' could not be found for UsersController</code></li>
<li>原因：没有<code>show</code>方法</li>
</ul>


<h3>编辑<code>controllers/users_controller</code>，增加<code>show</code>方法</h3>

<pre><code class="rb">class UsersController &lt; ApplicationController
  def show
  end
end
</code></pre>

<ul>
<li>测试失败：<code>Missing template users/show, application/show with {:loc...</code></li>
<li>原因：没有<code>show</code>模板</li>
</ul>


<h3>新建<code>users/show.html.haml</code></h3>

<p>拷贝<code>ui/user.html</code>内容至当前模板</p>

<pre><code class="rb">%section#user.box
  %h1 个人信息
  %img(src="#{gravatar_url('joe@example.com')}")
  %dl
    %dt.span1 ID:
    %dd
      %strong chucai
    %dt.span1 Since:
    %dd 2012年2月12日
</code></pre>

<p><strong>注意：当前用户故事只考虑基本用户信息，最新帖子和最新回复以后的步骤中会增加</strong></p>

<ul>
<li>测试失败：<code>expected there to be text "test_user" in "社区 会员 knowa...</code></li>
<li>原因：页面还是写死的数据</li>
</ul>


<h3>修改模板<code>users/show.html.haml</code></h3>

<pre><code class="rb">%section#user.box
  %h1 个人信息
  %img(src="#{gravatar_url('joe@example.com')}")
  %dl
    %dt.span1 ID:
    %dd
      %strong= @user.name
    %dt.span1 Since:
    %dd= @user.created_at
</code></pre>

<ul>
<li>测试失败：`undefined methodname' for nil:NilClass``</li>
<li>原因：没有对<code>@user</code>变量赋值</li>
</ul>


<h3>编辑<code>controllers/users_controller.rb</code></h3>

<pre><code class="rb">class UsersController &lt; ApplicationController
  def show
    @user = User.find(params[:id])
  end
end
</code></pre>

<ul>
<li>测试失败：<code>uninitialized constant UsersController::User</code></li>
<li>原因：没有<code>user</code>这个<code>model</code></li>
</ul>


<h3>在<code>rails console</code>中执行</h3>

<pre><code class="rb">[8] pry(main)&gt; generate "model user name:string"
      invoke  active_record
      create    db/migrate/20130101221838_create_users.rb
      create    app/models/user.rb
=&gt; "Completed"
[9] pry(main)&gt;
</code></pre>

<h3>执行数据库升级</h3>

<pre><code class="bash">bundle exec rake db:migrate
bundle exec rake db:test:prepare
</code></pre>

<ul>
<li>测试失败：<code>Couldn't find User with id=1</code></li>
<li>原因：测试用例中使用的是写死的数据</li>
</ul>


<h3>修改测试用例，增加<code>user</code>部分</h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到用户的信息' do
  background do
    @user = User.create name: "test_user"
  end

  scenario '访问/users/:id, 应该显示用户信息' do
    visit "/users/#{@user.id}"

    page.should have_content @user.name
    page.should have_content @user.created_at.to_s
  end
end
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h2>完成，提交代码</h2>

<pre><code class="bash">git add .
git commit 
git checkout dev
git merge f5 --no-ff
git branch -d f5
</code></pre>

<p>下一步骤：<a href="/blog/2013/01/06/ruby-china-clone-6">使用 RSpec+Capybara 简单BDD入门 -6</a></p>
