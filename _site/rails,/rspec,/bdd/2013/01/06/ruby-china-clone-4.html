<p><a href="/blog/2013/01/06/ruby-china-clone-cover">目录</a>
上一步：<a href="/blog/2013/01/06/ruby-china-clone-3">使用 RSpec+Capybara 简单BDD入门 -3</a></p>

<h2>用户故事</h2>

<p>访问者希望看到帖子的详细信息</p>

<ul>
<li>显示标题、内容、节点、创建日期</li>
<li>顶部的导航链接</li>
</ul>


<h2>环境准备</h2>

<pre><code class="bash">git checkout -b f4
rails c # console
rails s # server
</code></pre>

<h2>步骤</h2>

<h3>新建文件<code>spec/features/guest_can_see_topic_info_spec.rb</code></h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到帖子的详细信息' do
  background do
    @node = Node.create name: "Ruby"
    @topic = Topic.create title: "topic 1 test", node: @node
  end

  scenario '访问/topics/1, 应该显示帖子的详细信息' do
    visit "/topics/#{@topic.id}"

    page.should have_content @topic.title
    page.should have_content @topic.node.name
  end
end
</code></pre>

<ul>
<li>测试失败：<code>No route matches [GET] "/topics/1"</code></li>
<li>原因：没有<code>topics/1</code>对应的路由信息</li>
</ul>


<h3>编辑<code>config/routes.rb</code>，增加<code>topics show</code>的路由设置</h3>

<pre><code class="rb">  resources :topics, only: [:index, :show]
</code></pre>

<ul>
<li>测试失败：<code>The action 'show' could not be found for TopicsController</code></li>
<li>原因：<code>TopicsController</code>没有定义<code>show</code>方法</li>
</ul>


<h3>编辑<code>controllers/topics_controller.rb</code>，增加<code>show</code>方法定义</h3>

<pre><code class="rb">  def show
  end
</code></pre>

<ul>
<li>测试失败：<code>Missing template topics/show, application/show with {:lo...</code></li>
<li>原因：没有<code>show</code>模板</li>
</ul>


<h3>增加<code>topics/show.html.haml</code>，拷贝<code>ui/topic.html.haml</code>的内容至当前模板</h3>

<ul>
<li>测试失败：<code>expected there to be text "topic 1 test" in "社区 会...</code></li>
<li>原因：模板中是写死的假数据</li>
</ul>


<h3>修改<code>topics/show.html.haml</code>内容</h3>

<pre><code class="rb">= render 'shared/breadcrumb', links: [["Home", ""], ["社区", ""], ["新手问题", ""], ["浏览帖子", ""]]

%section#show_topic
  %section#topic_banner.box.info-box
    %h1= @topic.title
    %p.topic_info
      = link_to @topic.node.name, @topic.node, class: "node"
      %span= "  •  "
      = link_to "knwang", nil, class: "user_link"
      %span= "  •  "
      = "published #{@topic.created_at} ago"
  %section#topic_content.box
    %p= @topic.content

%section#sidebar
  %section#new_topic.box
    = link_to "发布新帖", nil, class: "btn btn-success"
  %section#stats.box
    %ul
      %li 社区会员: 4029 人
      %li 帖子数: 312 篇
      %li 回帖数: 3123 条
</code></pre>

<p><strong>注意：回复的部分在后面的步骤中做，暂时删掉即可</strong></p>

<ul>
<li>测试失败：`undefined methodtitle' for nil:NilClass``</li>
<li>原因：没有对<code>@topic</code>变量赋值</li>
</ul>


<h3>编辑<code>controllers/topics_controller.rb</code></h3>

<pre><code class="rb">  def show
    @topic = Topic.find(params[:id])
  end
</code></pre>

<ul>
<li>测试失败：`undefined methodcontent' for #&lt;Topic:0x0...``</li>
<li>原因：最开始生成<code>topic</code>的时候忘了<code>content</code>属性了 :)</li>
</ul>


<h3>在<code>rails console</code>中执行</h3>

<pre><code class="rb">[5] pry(main)&gt; generate "migration AddContentToTopics content:text"
      invoke  active_record
      create    db/migrate/20130101134732_add_content_to_topics.rb
=&gt; "Completed"
[6] pry(main)&gt;
</code></pre>

<h3>执行数据库升级</h3>

<pre><code class="bash">bundle exec rake db:migrate
bundle exec rake db:test:prepare
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h3>修改测试用例，增加内容和创建时间的验证</h3>

<pre><code class="rb"># coding: utf-8
feature '访问者希望看到帖子的详细信息' do
  background do
    @node = Node.create name: "Ruby"
    @topic = Topic.create title: "topic 1 test", content: "topic 1 content",  node: @node
  end

  scenario '访问/topics/1, 应该显示帖子的详细信息' do
    visit "/topics/#{@topic.id}"

    page.should have_content @topic.title
    page.should have_content @topic.content
    page.should have_content @topic.node.name
    page.should have_content "published #{@topic.created_at} ago"
  end
end
</code></pre>

<ul>
<li>测试失败：<code>Can't mass-assign protected attributes: content</code></li>
<li>原因：没有设置<code>content</code>的访问属性</li>
</ul>


<h3>编辑<code>model/topic.rb</code></h3>

<pre><code class="rb">  attr_accessible :title, :node, :content
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h2>再次确认用户故事</h2>

<h3>增加导航栏的验证</h3>

<pre><code class="rb">    page.should have_link "Home", href: root_path
    page.should have_link @topic.node.name, href: node_path(@topic.node)
    page.should have_link "浏览帖子", href: topic_path(@topic)
</code></pre>

<ul>
<li>测试失败：`undefined local variable or methodroot_path' for...``n</li>
<li>原因：没有<code>root_path</code>的定义</li>
</ul>


<h3>编辑<code>config/routes.rb</code>，增加<code>root_path</code>的定义</h3>

<pre><code class="rb">MyRubyChina::Application.routes.draw do
  resources :topics, only: [:index, :show]
  resources :nodes, only: [:show]

  root to: "topics#index"

  match 'ui/:action', controller: 'ui'
...
</code></pre>

<h4>删除默认的主页文件</h4>

<pre><code class="bash">rm public/index.html
</code></pre>

<ul>
<li>测试失败：<code>expected to find link "Home" but there were no matches. Als...</code></li>
<li>原因：没有定义对应的链接</li>
</ul>


<h3>编辑<code>topics/show.html.haml</code>，修改顶部导航栏链接</h3>

<pre><code class="rb">= render 'shared/breadcrumb', links: [["Home", root_path], [@topic.node.name, @topic.node], ["浏览帖子", @topic]]
</code></pre>

<ul>
<li>测试通过！</li>
</ul>


<h2>完成，提交代码</h2>

<pre><code class="bash">git add .
git rm public/index.html
git commit 
git checkout dev
git merge f4 --no-ff
git branch -d f4
</code></pre>

<p>下一步骤：<a href="/blog/2013/01/06/ruby-china-clone-5">使用 RSpec+Capybara 简单BDD入门 -5</a></p>
